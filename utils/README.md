# Utilities

This directory contains utility modules that provide shared functionalities across the UniMAG project. It serves as a toolbox for common operations, abstracting away implementation details.

---

## `embedding_manager.py`

This module provides the `EmbeddingManager` class, an interface for accessing pre-computed feature embeddings generated by the `embedding_converter` module. It simplifies the process of loading specific feature vectors for downstream tasks.

> [!IMPORTANT]
> Embeddings are currently being generated, so some dataset embedding files may be missing.

### Initialization

To use the manager, first import and instantiate it. You can optionally provide a custom path to your datasets.

```python
from utils.embedding_manager import EmbeddingManager

# Initialize with the default base path (e.g., /home/ai/MMAG on server)
manager = EmbeddingManager()

# Or, initialize with a custom base path
local_manager = EmbeddingManager(base_path="/home/ai/ylzuo/UniMAG/hugging_face")
```

**Constructor Parameters:**

| Parameter | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `base_path` | `str` or `Path` | `None` | The root directory for the datasets. If `None`, it uses the default path defined in `StorageManager` (e.g., `/home/ai/MMAG`). |


### Methods

#### `get_embedding()`

Retrieves a specific embedding as a NumPy array.

**Usage:**
```python
embedding = manager.get_embedding(
    dataset_name="books-nc",
    modality="text",
    encoder_name="Qwen/Qwen2.5-VL-3B-Instruct",
    dimension=768
)
```

**Parameters:**

| Parameter | Type | Description |
| :--- | :--- | :--- |
| `dataset_name` | `str` | The name of the dataset (e.g., "books-nc"). |
| `modality` | `str` | The feature modality. Can be "text", "image", or "multimodal". |
| `encoder_name` | `str` | The full Hugging Face model identifier. This is used to distinguish between different models or versions. For now, it can be "Qwen/Qwen2.5-VL-3B-Instruct", "Qwen/Qwen2.5-VL-7B-Instruct", "OpenGVLab/InternVL3-1B-hf". |
| `dimension` | `int` | (Optional) The dimension of the feature vector. Can be 128, 256, 512, 768, 1024, 2048, ... (Maximum depends on the model). Leave it as `None` if you want to use the default dimension of the model. |

**Returns:**
- A `numpy.ndarray` containing the feature vectors.
- `None` if the specified embedding file is not found.

#### `view_embedding()`

Displays the properties and a preview of a specific embedding file without loading the entire file into memory.

**Usage:**
```python
manager.view_embedding(
    dataset_name="books-nc",
    modality="text",
    encoder_name="Qwen/Qwen2.5-VL-3B-Instruct",
    dimension=768
)
```

**Parameters:**

| Parameter | Type | Description |
| :--- | :--- | :--- |
| `dataset_name` | `str` | The name of the dataset. |
| `modality` | `str` | The feature modality. |
| `encoder_name` | `str` | The full Hugging Face model identifier. |
| `dimension` | `int` | (Optional) The dimension of the feature vector. |

**Output:**
- Prints the file path, shape, data type, and the first few rows of the embedding array.